<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Status</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/customer_queue_style.css">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <script src="../js/jquery-3.6.0.min.js"></script>
    <style>
        /* Styling for pill-shaped buttons */
        .nav-pills .nav-link {
            border-radius: 50px;
            font-weight: bold;
            padding: 10px 20px;
            text-align: center;
        }

        .nav-pills .nav-link.active {
            background-color: #007bff;
            color: #fff;
        }

        .tab-content {
            margin-top: 20px;
        }
        
        .center-message {
            text-align: center;
        }

        #attention-color {
            color: rgba(141, 78, 27, 0.801);
        }

        .gray {
            color: gray;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>STI College - Tagaytay</header>

    <!-- Main Container -->
    <div class="container" id="container">
        <div class="wait-time"><span id="waiting-time">00:00</span></div>     
        <p id="confirmation-text">You have successfully joined the queue.</p>
        
        <div class="hint-text" id="window-name"><strong>Location</strong></div>
        <div class="hint-text">Your number is:</div>
        <div class="queue-number" id="queue-number">Number</div>
        <p class="hint-text" id="timestamp-text">Timestamp</p>
    </div>

    <div class="container" id="form-container">
        <!-- Warning message -->
        <i><p class="center-message gray"><span id="attention-color">Attention:</span> Internet connection is required to send data to the system.</p></i>
        <!-- Pill Navigation for SMS and Email -->
        <ul class="nav nav-pills justify-content-center" id="promptTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="sms-tab" data-bs-toggle="tab" data-bs-target="#sms" type="button" role="tab" aria-controls="sms" aria-selected="true">SMS</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false">Email</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
            <!-- SMS Tab -->
            <div class="tab-pane fade show active" id="sms" role="tabpanel" aria-labelledby="sms-tab">
                <form id="sms-form">
                    <label for="mobile-number">Mobile Number</label>
                    <input type="number" id="mobile-number" class="form-control" placeholder="Enter Mobile Number" pattern="[0-9]*" maxlength="13" required>
                    <button type="submit" class="btn btn-primary mt-3 w-100">Send Mobile Number</button>
                </form>
            </div>

            <!-- Email Tab -->
            <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                <form id="email-form">
                    <label for="email-address">Email Address</label>
                    <input type="email" id="email-address" class="form-control" placeholder="Enter Email Address" required>
                    <p id="validation-message"></p>
                    <button type="submit" class="btn btn-primary mt-3 w-100">Send Email</button>
                </form>
            </div>
        </div>
    </div>

    <!-- emailjs -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- inline script -->
    <script>
        const mobileNumberTextInput = document.getElementById('mobile-number');
        const emailTextInput = document.getElementById('email-address');

        let mobileNumber;
        let emailAddress;

        // JavaScript to manage tab switching and forms
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for form submission
            const smsForm = document.getElementById('sms-form');
            const emailForm = document.getElementById('email-form');

            smsForm.addEventListener('submit', (event) => {
                event.preventDefault();
                mobileNumber = mobileNumberTextInput.value;
                updateCustomerContactData(mobileNumber, null, queueID);
            });

            emailForm.addEventListener('submit', (event) => {
                event.preventDefault();
                emailAddress = emailTextInput.value;
                // updateCustomerContactData(null, emailAddress, queueID);
                updateCustomerContactData(null, emailAddress);
            });
        });

        // Updates customer information for notification
        async function updateCustomerContactData(mobileNumber, emailAddress){
            try {
                if (!mobileNumber) console.error("No mobile number was received"); else localStorage.setItem('mobileNumber', mobileNumber);
                if (!emailAddress) console.error("No email address received."); else localStorage.setItem('emailAddress', emailAddress); sendEmailNotification(); // DEBUG

                console.log(`Mobile number: ${localStorage.getItem('mobileNumber')} ; Email Address: ${localStorage.getItem('emailAddress')}`);
            } catch (error) {
                console.error('Error updating customer contact data');
            }
        }

        // Checks time and sends a signal if it's time to send a notification
        async function checkNotificationTime(){
            try {
                // If it's time to send a notification call the following below:
                // sendEmailNotification();
                // sendSMSNotification();
                // sendNativeNotification();
            } catch (error) {
                console.error(`Error sending notification to user: ${error}`);
            }

        }


        async function sendEmailNotification() {
            try {
                if (!emailAddress) throw new Error('No email address was saved');

                // Update accordingly depending on variables
                // TODO : HIDE THESE
                const emailAccountValue = process.env.EMAIL_ACCOUNT_VALUE;
                const emailTemplateValue = process.env.EMAIL_ACCOUNT_VALUE; // Your email template ID
                const emailServiceValue = process.env.EMAIL_SERVICE_VALUE; // Your email service ID

                // Initialize EmailJS
                emailjs.init(emailAccountValue);

                const emailTemplateParams = {
                    to_email: emailAddress, // Recipient's email address
                    queue_number: queueNumber, // Queue number to include in the email
                    from_name: "qSTI", // Sender's name
                    message: `You have received an email notification! Congratulations! It works!`, // Email body
                };

                // Send the email notification
                const response = await emailjs.send(emailServiceValue, emailTemplateValue, emailTemplateParams);
                console.log("Notification sent successfully:", response);

                // Optional: Remove saved email address
                // localStorage.removeItem('emailAddress');
            } catch (error) {
                console.error(`Error sending email notification. ${error}`);
            }
        }

        async function sendSMSNotification(event) {
            try {
                event.preventDefault(); // Ensure the event object is passed

                const mobileNumber = localStorage.getItem('mobileNumber'); // Retrieve from localStorage
                if (!mobileNumber) throw new Error('No mobile number was saved');

                const response = await fetch("/sendNotification", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mobileNumber }), // Send the mobile number as JSON
                });

                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

                const result = await response.json();
                if (result.success) {
                    console.log("SMS sent successfully");
                } else {
                    throw new Error(result.message || "SMS failed to send");
                }

                localStorage.removeItem('mobileNumber'); // Clean up after successful operation
            } catch (error) {
                console.error(`Error sending SMS notification: ${error}`);
            }
        }


        // Send an in-browser notification
        // TODO: must have a single jingle sound
        async function sendNativeNotification(){
            // Have animation here that will notify in-browser
        }

        // DEFUNCT TO MAKE THINGS EASIER FOR THE SERVER
        // async function updateCustomerContactData(mobileNumber, emailAddress, queueID){
        //     try {
        //         if (!mobileNumber) console.error("No mobile number was received");
        //         if (!emailAddress) console.error("No email address received.");

        //         const response = await fetch(`http://localhost/queue_management/php/update_notification_contact.php?contactNumber=${mobileNumber}&email=${emailAddress}&queueID=${queueID}`);
        //         // const response = await fetch(`../php/update_notification_contact.php?contactNumber=${mobileNumber}&email=${emailAddress}&queueID=${queueID}`);
        //         if (!response.ok) throw new Error('Network response was not ok');
        //     } catch (error) {
        //         console.error('Error updating customer contact data', error);
        //     }
        // }

        // EMAIL TEXT INPUT LISTENERS
        // Add an input event listener for dynamic validation
        emailTextInput.addEventListener('input', function () {
            // Get the current value of the input field
            let email = emailTextInput.value;

            // Remove whitespace and any invalid characters
            email = email.replace(/\s+/g, ''); // Remove all whitespace
            email = email.replace(/[^a-zA-Z0-9@._-]/g, ''); // Remove invalid characters for email

            // Update the value of the text input field
            emailTextInput.value = email;

            // Check if the email is valid
            if (validateEmail(email)) {
                emailTextInput.style.borderColor = 'green'; // Indicate valid input
            } else {
                emailTextInput.style.borderColor = 'red'; // Indicate invalid input
            }
        });

        // Function to validate email format
        function validateEmail(email) {
            // Regex for validating an email address
            const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        // MOBILE TEXT INPUT LISTENERS
        // Add an event listener to enforce the rules as the user types
        mobileNumberTextInput.addEventListener('input', function () {
            // Remove all characters except numbers and the '+' sign
            this.value = this.value.replace(/[^0-9+]/g, '');

            // Enforce a maximum length of 13 characters
            if (this.value.length > 13) {
                this.value = this.value.slice(0, 13);
            }
        });

        // Add validation on form submission to ensure the length is between 11 and 13 characters
        mobileNumberTextInput.closest('form').addEventListener('submit', function (event) {
            const inputLength = mobileNumberTextInput.value.length;

            if (inputLength < 11 || inputLength > 13) {
                event.preventDefault(); // Prevent form submission
                alert('The mobile number must be between 11 and 13 characters long.');
            }
        });

        // REIMPORT FROM OLD FILES
        const windowNameText = document.getElementById('window-name');
        const queueNumberText = document.getElementById('queue-number');
        const timestampText = document.getElementById('timestamp-text');
        const queueMessageText = document.getElementById('confirmation-text');
        const waitingTimeEl = document.getElementById('waiting-time');
        const token = new URLSearchParams(window.location.search).get('token');
        const params = new URLSearchParams(window.location.search);
        const queueLocation = params.get('location');
        const queueNumber = params.get('queue');
        const queueID = params.get('queueID');
        const timestamp = new Date(params.get('timestamp')).toLocaleString();
        // const timestamp = params.get('timestamp');
    
        console.log(`queueID from the queue is: ${queueID || null}`);

        // Countdown timer for estimated waiting time
        let totalSeconds = 300; // 5 minutes
        function startCountdown() {
            const interval = setInterval(() => {
                if (totalSeconds > 0) {
                    totalSeconds--;
                    const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                    waitingTimeEl.textContent = `${minutes}:${seconds}`;
                } else {
                    clearInterval(interval);
                    waitingTimeEl.textContent = '00:00';
                }
            }, 1000);
        }
    
        // Display queue information
        function setInnerTexts() {
            try {
                if (queueLocation && queueNumber && timestamp) {
                    console.log(queueLocation, ' ', queueNumber, ' ', timestamp);
                    startCountdown();
                    windowNameText.innerText = `${queueLocation}`;
                    queueNumberText.innerText = `${queueNumber}`;
                    timestampText.innerText = `${timestamp}`;
                } else {
                    throw new Error('Queue information is incomplete.');
                }
            } catch (error) {
                $("#container").load(`invalid_queue.html`);
                $("#form-container").hide();
                console.log('Invalid page loaded');
                alert('This is an invalid queue card.');
            }
        }
    
        // Send data to the server when page loads
        function sendCustomerData() {
            if (!queueLocation || !queueNumber || !timestamp || !queueID) {
                console.error('Missing data: queueLocation, queueNumber, queueID, or timestamp is not defined.');
                return;
            }
    
            const customerData = {
                location: queueLocation,
                queueNumber: queueNumber,
                timestamp: timestamp,
                queueID: queueID
            };
    
            // Send data to the customer updates endpoint
            fetch('https://qrcodesti.onrender.com/api/customer-updates', { // Use full URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customerData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(updatedData => {
                // document.getElementById('confirmation-text').innerText = 
                //     `You have joined the queue for ${updatedData.location}. Your queue number is ${updatedData.queueNumber}. The QR code was generated at: ${updatedData.timestamp}.`;
                // alert("Customer data sent successfully!");
                console.log("Customer data sent successfully!");
            })
            .catch(error => {
                console.error('Error sending customer data:', error);
                alert("Error sending customer data!", error.toString());
            });
        }
    
        // Verify token and establish WebSocket connection
        const socket = new WebSocket('wss://qrcodesti.onrender.com'); // Use wss:// for WebSocket
    
        socket.addEventListener('open', function () {
            if (token) {
                fetch('https://qrcodesti.onrender.com/verify_access.php', { // Update to full URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'already_accessed') {
                        alert('This page has already been accessed. You cannot open it again.');
                    }
                });
            }
    
            // Send customer data through WebSocket
            const customerData = {
                location: queueLocation,
                queueNumber: queueNumber,
                timestamp: timestamp,
                queueID: queueID
            };
            socket.send(JSON.stringify(customerData));
        });
    
        socket.addEventListener('error', function (error) {
            console.error('WebSocket error:', error);
        });
    
        socket.addEventListener('close', function () {
            console.log('WebSocket connection closed');
        });
    
        // Start countdown and initialize page content
        document.addEventListener('DOMContentLoaded', function() {
            sendCustomerData();
            setInnerTexts();

            $("#timestamp-text").hide();
        });
    </script>
    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html>
